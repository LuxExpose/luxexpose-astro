---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";

const FUNCTIONS_BASE = "https://ppmdgygupuzthqxfippv.supabase.co/functions/v1";
const SITE_URL = "https://luxexpose.com";

const rawSlug = Astro.params.slug ?? "";
const slug = rawSlug.replace(/^\/+/, "").replace(/\/+$/, "");

let article: any = null;

try {
  const response = await fetch(`${FUNCTIONS_BASE}/mobile-api-article`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ slug, includeRelated: true }),
  });

  if (response.ok) {
    const payload = await response.json();
    article = payload?.article ?? null;
  }
} catch {
  article = null;
}

if (!article) {
  return new Response("Article not found", { status: 404 });
}

function stripHtml(html = "") {
  return html.replace(/<[^>]*>/g, "").replace(/\s+/g, " ").trim().slice(0, 160);
}

function formatDate(value: string | undefined) {
  if (!value) return "";
  try {
    return new Date(value).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  } catch {
    return value || "";
  }
}

const seoTitle = article.seo_title || article.title || "Lux Exposé";
const seoDescription =
  article.seo_description ||
  article.excerpt ||
  stripHtml(article.content_html) ||
  `Read "${article.title}" on Lux Exposé.`;

const featuredImage =
  article.featured_image ||
  "https://luxexpose.com/wp-content/uploads/2023/08/LuxExpose-Logo.png";

const canonicalSlug = (article.slug || slug).replace(/^\/+/, "");
const canonicalUrl = `${SITE_URL}/${canonicalSlug}`;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: article.title,
  description: seoDescription,
  image: featuredImage,
  datePublished: article.published_at || undefined,
  dateModified: article.updated_at || article.published_at || undefined,
  author: { "@type": "Organization", name: "Lux Exposé" },
  publisher: { "@type": "Organization", name: "Lux Exposé" },
  mainEntityOfPage: { "@type": "WebPage", "@id": canonicalUrl },
  url: canonicalUrl,
};
---

<Layout>
  <span slot="title">{seoTitle}</span>

  <meta slot="head" name="description" content={seoDescription} />
  <link slot="head" rel="canonical" href={canonicalUrl} />

  <!-- Open Graph -->
  <meta slot="head" property="og:title" content={seoTitle} />
  <meta slot="head" property="og:description" content={seoDescription} />
  <meta slot="head" property="og:image" content={featuredImage} />
  <meta slot="head" property="og:url" content={canonicalUrl} />
  <meta slot="head" property="og:type" content="article" />
  <meta slot="head" property="og:site_name" content="Lux Exposé" />

  <!-- Twitter -->
  <meta slot="head" name="twitter:card" content="summary_large_image" />
  <meta slot="head" name="twitter:title" content={seoTitle} />
  <meta slot="head" name="twitter:description" content={seoDescription} />
  <meta slot="head" name="twitter:image" content={featuredImage} />

  <!-- JSON-LD -->
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <Navbar />

  <div class="relative bg-gradient-subtle min-h-screen">
    <main class="container max-w-4xl mx-auto px-6 pt-28 pb-24">
      {article.categories?.name && (
        <div class="mb-6">
          <span class="inline-block px-4 py-2 rounded-full bg-black/70 backdrop-blur border border-white/20 text-sm uppercase tracking-wider text-white/90">
            {article.categories.name}
          </span>
        </div>
      )}

      <h1 class="font-serif text-4xl md:text-5xl lg:text-6xl mb-6">
        {article.title}
      </h1>

      {article.published_at && (
        <p class="text-sm uppercase tracking-[0.2em] text-white/50 mb-6">
          {formatDate(article.published_at)}
        </p>
      )}

      {article.excerpt && (
        <p class="text-lg text-white/70 mb-8 max-w-3xl">
          {article.excerpt}
        </p>
      )}

      {article.featured_image && (
        <div class="mb-10 rounded-xl overflow-hidden">
          <img
            src={article.featured_image}
            alt={article.title}
            class="w-full h-auto"
            loading="eager"
          />
        </div>
      )}

      <article class="prose prose-invert max-w-none article-content">
        <div set:html={article.content_html || ""} />
      </article>
    </main>
  </div>
</Layout>