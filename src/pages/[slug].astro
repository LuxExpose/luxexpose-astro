export const prerender = false;
---
import { supabase } from "../lib/supabase";

const rawSlug = Astro.params.slug ?? "";
const slug = rawSlug.replace(/^\/+/, "").replace(/\/+$/, "");

const siteUrl = process.env.SITE_URL ?? "http://localhost:4323";

// Fetch article from the public view (now includes content_html)
let { data: article, error } = await supabase
  .from("public_articles")
  .select("id, title, slug, excerpt, content_html, featured_image, published_at")
  .eq("slug", slug)
  .maybeSingle();

// Fallback if DB stored slugs like "/slug"
if (!article && !error) {
  const res = await supabase
    .from("public_articles")
    .select("id, title, slug, excerpt, content_html, featured_image, published_at")
    .eq("slug", `/${slug}`)
    .maybeSingle();

  article = res.data;
  error = res.error;
}

if (!article) {
  return new Response(`Article not found for slug: ${slug}`, { status: 404 });
}

const title = article.title ?? "Lux Exposé";
const description =
  (typeof article.excerpt === "string" && article.excerpt.trim()) ||
  `Read “${title}” on Lux Exposé.`;

const image =
  article.featured_image ??
  "https://luxexpose.com/wp-content/uploads/2023/08/LuxExpose-Logo.png";

const canonical = `${siteUrl}/${(article.slug ?? slug).replace(/^\/+/, "")}`;

const html = article.content_html ?? "";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title} | Lux Exposé</title>

    <link rel="canonical" href={canonical} />

    <!-- Open Graph -->
    <meta property="og:title" content={`${title} | Lux Exposé`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:url" content={canonical} />
    <meta property="og:type" content="article" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${title} | Lux Exposé`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={image} />
  </head>

  <body style="max-width:820px;margin:40px auto;padding:0 16px;font-family:system-ui;line-height:1.6;">
    <h1>{title}</h1>
    <p style="opacity:.75">{description}</p>
    <hr style="margin:24px 0;" />

    {html ? (
      <div set:html={html}></div>
    ) : (
      <p style="opacity:.6">No HTML body found yet for this article.</p>
    )}
  </body>
</html>