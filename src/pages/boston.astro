---
import Layout from "../layouts/Layout.astro";
import CityNavbar from "../components/city/CityNavbar.astro";
import ArticleGrid from "../components/ArticleGrid.astro";
import CityAmbience from "../components/city/CityAmbience.astro";
import CityHeroSection from "../components/city/CityHeroSection.astro";
import CityHeroTagline from "../components/city/CityHeroTagline.astro";
import { getCityCopy } from "../data/cityCopywriting";
import CityStatsBox from "../components/CityStatsBox.astro";
import CityMap from "../components/CityMap.astro";
import GlobalTrendingWidget from "../components/GlobalTrendingWidget.astro";
import ExperiencesSidebar from "../components/ExperiencesSidebar.astro";
import Pagination from "../components/Pagination.astro";
import NeighborhoodExplorer from "../components/NeighborhoodExplorer.astro";
import { getCityConfig } from "../utils/cityConfig";
import { fetchAllCategories } from "../utils/categories";
import { fetchLocationIdBySlug, fetchLocationBySlug } from "../utils/locations";
import { fetchCompleteCityData } from "../utils/cities/fetchCityData";
import {
  getCityLocationId,
  getCityData,
  cityMapLocations,
} from "../data/cities";

const FUNCTIONS_BASE = "https://ppmdgygupuzthqxfippv.supabase.co/functions/v1";
const SITE_URL = "https://luxexpose.com";
const SUPABASE_URL = "https://ppmdgygupuzthqxfippv.supabase.co";
const SUPABASE_ANON_KEY = import.meta.env.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwbWRneWd1cHV6dGhxeGZpcHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDU0MjYsImV4cCI6MjA3NDk4MTQyNn0.JdOoMgW7oXtHycvJGl9buYagZaGXoqkU9rF0KnTNKX4";

const citySlug = "boston";
const city = getCityConfig(citySlug);
if (!city) {
  return new Response("City not found", { status: 404 });
}

// Database-First Approach: Fetch all city data from Supabase
const cityDataFromDB = await fetchCompleteCityData(citySlug);
const cityData = getCityData(citySlug); // Static fallback

// Use database data if available, otherwise fallback to static
const locationId = cityDataFromDB?.location.id || null;
const cityMetadata = cityDataFromDB?.location || null;

// Neighborhoods: Database first, static fallback
let neighborhoods = [];
if (cityDataFromDB?.neighborhoods && cityDataFromDB.neighborhoods.length > 0) {
  neighborhoods = cityDataFromDB.neighborhoods.map(function(n) {
    return {
      name: n.name,
      slug: n.slug,
      description: n.description,
      image: n.image_url,
    };
  });
} else {
  // Fallback to static data
  neighborhoods = cityData?.neighborhoods || [];
}

// Stats: Database first, static fallback
let stats = [];
if (cityDataFromDB?.stats && cityDataFromDB.stats.length > 0) {
  stats = cityDataFromDB.stats.map(function(s) {
    return {
      icon: s.icon,
      label: s.label,
      value: s.value,
      description: s.description || '',
    };
  });
} else {
  // Fallback to static data
  stats = cityData?.stats || [];
}

// Copy: Database first, static fallback
const copy = cityDataFromDB?.copy || cityData?.copy || null;

// Get location_id for article fetching (database first, then fallback)
let articleLocationId = locationId;
if (!articleLocationId) {
  const fallbackLocationId = getCityLocationId(citySlug);
  if (fallbackLocationId) {
    if (import.meta.env.DEV) {
      console.warn(`[Boston Page] Using fallback location_id: ${fallbackLocationId}`);
    }
    articleLocationId = fallbackLocationId;
  } else {
    console.error(`[Boston Page] ERROR: No location_id found for city slug: ${citySlug}`);
    return new Response(`Missing location data for ${city.name}. Please check the locations table in Supabase.`, { status: 500 });
  }
}

// Fetch featured articles for hero (featured_in_city = true, limit 5)
let featuredArticles = [];
if (articleLocationId) {
  try {
    const featuredResponse = await fetch(
      `${SUPABASE_URL}/rest/v1/articles?location_id=eq.${articleLocationId}&featured_in_city=eq.true&status=eq.published&select=id,title,slug,excerpt,featured_image,featured_video_url,published_at,categories(name,slug)&order=published_at.desc&limit=5`,
      {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        },
      }
    );
    if (featuredResponse.ok) {
      featuredArticles = await featuredResponse.json() || [];
    }
  } catch (error) {
    console.error("Error fetching featured articles:", error);
  }
}

// Get URL query parameters
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q') || '';
const categorySlug = url.searchParams.get('category') || 'all';
const currentPage = parseInt(url.searchParams.get('page') || '1');
const ARTICLES_PER_PAGE = 12;

// Fetch ALL categories (for navbar, show all regardless of article count)
const categoriesData = await fetchAllCategories();
const categories = categoriesData.map((cat) => ({
  slug: cat.slug,
  name: cat.name,
}));

// Prepare categories for city navbar (with paths using query params)
const categoryLinks = categories.map((cat) => ({
  name: cat.name,
  slug: cat.slug,
  path: `/boston?category=${cat.slug}`,
}));

// Fetch regular articles (filtered by location_id, search, category)
let articles = [];
let totalArticles = 0;

if (articleLocationId) {
  try {
    // Build query URL
    let articlesUrl = `${SUPABASE_URL}/rest/v1/articles?location_id=eq.${articleLocationId}&status=eq.published&select=id,title,slug,excerpt,featured_image,published_at,categories(name,slug)`;
    
    // Apply category filter
    if (categorySlug !== 'all') {
      const category = categoriesData.find((c) => c.slug === categorySlug);
      if (category) {
        articlesUrl += `&category_id=eq.${category.id}`;
      }
    }
    
    // Apply search filter (title search)
    if (searchQuery) {
      articlesUrl += `&title=ilike.%25${encodeURIComponent(searchQuery)}%25`;
    }
    
    // Get total count
    const countUrl = articlesUrl.replace(
      'select=id,title,slug,excerpt,featured_image,published_at,categories(name,slug)',
      'select=id'
    );
    const countResponse = await fetch(countUrl, {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        Prefer: 'count=exact',
      },
    });
    if (countResponse.ok) {
      const countHeader = countResponse.headers.get('content-range');
      if (countHeader) {
        totalArticles = parseInt(countHeader.split('/')[1]) || 0;
      }
    }

    // Apply pagination
    const offset = (currentPage - 1) * ARTICLES_PER_PAGE;
    articlesUrl += `&order=published_at.desc&limit=${ARTICLES_PER_PAGE}&offset=${offset}`;

    // Get articles
    const articlesResponse = await fetch(articlesUrl, {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      },
    });
    if (articlesResponse.ok) {
      articles = (await articlesResponse.json()) || [];
    }
  } catch (error) {
    console.error('Error fetching city articles:', error);
  }
}

// Fetch trending articles for sidebar (globally)
let trendingArticles = [];
try {
  const trendingResponse = await fetch(
    `${SUPABASE_URL}/rest/v1/articles?status=eq.published&select=id,title,slug,featured_image,categories(name,slug),locations(name,slug)&order=published_at.desc&limit=5`,
    {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      },
    }
  );
  if (trendingResponse.ok) {
    trendingArticles = (await trendingResponse.json()) || [];
  }
} catch (error) {
  console.error('Error fetching trending articles:', error);
}

// Fetch experiences for sidebar (placeholder - adjust based on your schema)
let experiences = [];
// TODO: Add experiences fetch when schema is available

// SEO
const seoTitle = cityMetadata?.meta_title || `Boston Luxury Lifestyle | Lux Boston - Premier Guide to Boston's Finest | Lux Exposé`;
const seoDescription = cityMetadata?.meta_description || copy?.hero_subtext || copy?.heroSubtext || city.description;
const canonicalUrl = `${SITE_URL}/${city.slug}`;
const heroImage = cityMetadata?.hero_image || featuredArticles[0]?.featured_image || "https://luxexpose.com/wp-content/uploads/2023/08/LuxExpose-Logo.png";

// Multiple JSON-LD Schemas
const localBusinessSchema = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  name: "Lux Boston",
  description: "Boston's premier luxury lifestyle guide featuring historic hotels, Michelin-starred restaurants, exclusive events, and high-end shopping.",
  url: canonicalUrl,
  logo: "https://luxexpose.com/wp-content/uploads/2023/08/LuxExpose-Logo.png",
  image: heroImage,
  areaServed: {
    "@type": "City",
    name: "Boston",
    addressRegion: "MA",
    addressCountry: "US",
  },
  keywords: city.keywords.join(", "),
};

const collectionPageSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: "Boston Luxury Lifestyle Guide",
  description: seoDescription,
  url: canonicalUrl,
  about: {
    "@type": "City",
    name: "Boston",
    addressRegion: "Massachusetts",
    addressCountry: "United States",
  },
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: SITE_URL },
    { "@type": "ListItem", position: 2, name: "Boston", item: canonicalUrl },
  ],
};

const articleListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  name: "Boston Luxury Articles",
  numberOfItems: totalArticles,
  itemListElement: articles.slice(0, 10).map((article: any, index: number) => ({
    "@type": "ListItem",
    position: index + 1,
    url: `${SITE_URL}/${article.slug}`,
    name: article.title,
  })),
};

const allSchemas = [localBusinessSchema, collectionPageSchema, breadcrumbSchema, articleListSchema];
---

<Layout>
  <span slot="title">{seoTitle}</span>

  <meta slot="head" name="description" content={seoDescription} />
  <meta slot="head" name="keywords" content={city.keywords.join(", ")} />
  <link slot="head" rel="canonical" href={canonicalUrl} />

  <!-- Open Graph -->
  <meta slot="head" property="og:title" content={seoTitle} />
  <meta slot="head" property="og:description" content={seoDescription} />
  <meta slot="head" property="og:image" content={heroImage} />
  <meta slot="head" property="og:url" content={canonicalUrl} />
  <meta slot="head" property="og:type" content="website" />
  <meta slot="head" property="og:site_name" content="Lux Exposé" />
  <meta slot="head" property="og:region" content={city.state} />
  <meta slot="head" property="og:country-name" content={city.country} />

  <!-- Twitter -->
  <meta slot="head" name="twitter:card" content="summary_large_image" />
  <meta slot="head" name="twitter:title" content={seoTitle} />
  <meta slot="head" name="twitter:description" content={seoDescription} />
  <meta slot="head" name="twitter:image" content={heroImage} />

  <!-- Geo Tags -->
  <meta slot="head" name="geo.region" content={city.state ? `${city.country}-${city.state}` : city.country} />
  <meta slot="head" name="geo.placename" content={city.name} />

  <!-- Multiple JSON-LD Schemas -->
  {allSchemas.map((schema) => (
    <script slot="head" type="application/ld+json" set:html={JSON.stringify(schema)} />
  ))}

  <!-- City Navbar -->
  <CityNavbar 
    city="boston" 
    categories={categoryLinks}
    activeCategorySlug={categorySlug !== 'all' ? categorySlug : undefined}
  />
  
  <!-- Spacer to account for fixed navbar height -->
  <div class="city-navbar-spacer"></div>

      <div class={`relative bg-gradient-subtle min-h-screen ${city.themeClass || ''}`}>
        <!-- City Ambience Background -->
        <CityAmbience city={citySlug} />
        
        <!-- Hero Section -->
        <CityHeroSection 
          city={citySlug} 
          cityId={articleLocationId || ''}
          articles={featuredArticles.length > 0 ? featuredArticles.map(art => ({
            id: art.id,
            title: art.title,
            slug: art.slug,
            excerpt: art.excerpt || null,
            featured_image: art.featured_image || null,
            featured_video_url: art.featured_video_url || null,
            published_at: art.published_at || null,
            categories: art.categories ? {
              name: art.categories.name || '',
              slug: art.categories.slug || ''
            } : null
          })) : undefined}
        />

        <!-- Hero Tagline Section - Static copywriting first (correct text), then database fallback -->
        {(() => {
          const cityCopy = getCityCopy(citySlug);
          // Use static copywriting first to ensure correct text, then database as fallback
          const tagline = cityCopy?.heroTagline || copy?.hero_tagline || copy?.heroTagline || `Experience Luxury in ${city.name}`;
          const subtext = cityCopy?.heroSubtext || copy?.hero_subtext || copy?.heroSubtext || city.description;
          return tagline && subtext ? (
            <CityHeroTagline heroTagline={tagline} heroSubtext={subtext} />
          ) : null;
        })()}

    <!-- Stats Box (if stats exist) - Database first, static fallback -->
    {stats.length > 0 && (
      <section class="container mx-auto px-4 sm:px-6 py-12 md:py-16">
        <CityStatsBox
          stats={stats}
          explorationHeadline={copy?.exploration_headline || copy?.explorationHeadline || "Curated for the Ultra-High-Net-Worth"}
          explorationSubtext={copy?.exploration_subtext || copy?.explorationSubtext || "Access world-class experiences."}
          cityName={city.name}
        />
      </section>
    )}

    <!-- Main Content Section -->
    <section class="main-content-section">
      <div class="content-layout">
        <!-- Articles Column (70%) -->
        <main class="main-content-column">
          {articles.length > 0 ? (
            <>
              <ArticleGrid articles={articles} />
              {Math.ceil(totalArticles / ARTICLES_PER_PAGE) > 1 && (
                <Pagination
                  currentPage={currentPage}
                  totalPages={Math.ceil(totalArticles / ARTICLES_PER_PAGE)}
                  baseUrl="/boston"
                  queryParams={url.search}
                />
              )}
            </>
          ) : (
            <div class="text-center py-12">
              <p class="text-white/60 text-lg">
                No articles found. Try adjusting your filters.
              </p>
            </div>
          )}
        </main>

        <!-- Sidebar Column (30%) -->
        <aside class="sidebar-column">
          <div class="sidebar-sticky">
            <GlobalTrendingWidget
              articles={trendingArticles.map((art) => ({
                id: art.id,
                title: art.title,
                slug: art.slug,
                featured_image: art.featured_image,
                categories: art.categories
                  ? { name: art.categories.name, slug: art.categories.slug }
                  : undefined,
                locations: art.locations
                  ? { name: art.locations.name, slug: art.locations.slug }
                  : undefined,
              }))}
            />
            <ExperiencesSidebar experiences={experiences} />
          </div>
        </aside>
      </div>
    </section>

    <style>
      /* Main content section container */
      .main-content-section {
        width: 100%;
        max-width: 80rem;
        margin: 0 auto;
        padding: 0 1rem 3rem;
      }

      /* Flex layout for main + sidebar */
      .content-layout {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      @media (min-width: 1024px) {
        .content-layout {
          flex-direction: row;
          gap: 2rem;
        }
      }

      /* Main content column - 70% on desktop */
      .main-content-column {
        flex: 1;
        min-width: 0; /* Prevents flex overflow issues */
      }

      @media (min-width: 1024px) {
        .main-content-column {
          width: 70%;
          flex: none; /* Fixed width, not flexible */
        }
      }

      /* Sidebar column - 30% on desktop */
      .sidebar-column {
        width: 100%;
      }

      @media (min-width: 1024px) {
        .sidebar-column {
          width: 30%;
          flex-shrink: 0; /* Don't shrink below 30% */
        }
      }

      /* THE STICKY MAGIC */
      .sidebar-sticky {
        position: sticky;
        top: 6rem; /* 96px - accounts for navbar height */
        height: fit-content; /* Only as tall as its content */
        max-height: calc(100vh - 8rem); /* Prevent exceeding viewport */
        overflow-y: auto; /* Scroll if content is too long */

        /* Custom scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: rgba(218, 165, 32, 0.3) transparent;
      }

      .sidebar-sticky::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar-sticky::-webkit-scrollbar-track {
        background: transparent;
      }

      .sidebar-sticky::-webkit-scrollbar-thumb {
        background-color: rgba(218, 165, 32, 0.3);
        border-radius: 4px;
      }

      /* Gap between sidebar widgets */
      .sidebar-sticky > :global(* + *) {
        margin-top: 1.5rem; /* 24px gap between widgets */
      }
    </style>

    <!-- Additional Content Sections -->
    <section class="container mx-auto px-4 sm:px-6 py-12 md:py-16">
      <!-- Category Introduction -->
      {(copy?.category_intro || copy?.categoryIntro) && (
        <div class="max-w-4xl mx-auto mb-12 md:mb-16">
          <div class="prose prose-invert max-w-none">
            <p class="text-white/80 text-lg md:text-xl leading-relaxed text-center">
              {copy.category_intro || copy.categoryIntro}
            </p>
          </div>
        </div>
      )}

      <!-- Map Section -->
      <div class="mb-12 md:mb-16">
        <CityMap
          cityName={city.name}
          centerLat={42.3601}
          centerLng={-71.0589}
          zoom={12}
          locations={cityMapLocations[citySlug] || []}
        />
      </div>
    </section>

    <!-- Neighborhoods Section -->
    {neighborhoods && neighborhoods.length > 0 && (
      <NeighborhoodExplorer
        citySlug={citySlug}
        neighborhoods={neighborhoods}
        title="Explore the Neighborhoods"
        subtitle="Discover the unique character and luxury offerings of each distinctive area"
      />
    )}

    <!-- Experience Callout -->
    {(copy?.experience_callout || copy?.experienceCallout) && (
      <section class="container mx-auto px-4 sm:px-6 py-12 md:py-16">
        <div class="max-w-4xl mx-auto pt-12 border-t border-white/10">
          <div class="text-center">
            <p class="text-white/80 text-lg md:text-xl italic leading-relaxed">
              {copy.experience_callout || copy.experienceCallout}
            </p>
          </div>
        </div>
      </section>
    )}
  </div>
</Layout>
