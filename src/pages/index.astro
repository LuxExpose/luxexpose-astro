---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import HeroSlider from "../components/HeroSlider.astro";
import PlatformPillars from "../components/PlatformPillars.astro";
import FeaturedBrandsMarquee from "../components/FeaturedBrandsMarquee.astro";
import BeyondTheEditorial from "../components/BeyondTheEditorial.astro";
import LuxuryQuotes from "../components/LuxuryQuotes.astro";
import EditorialGrid from "../components/EditorialGrid.astro";
import Footer from "../components/Footer.astro";

const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL || 'https://ppmdgygupuzthqxfippv.supabase.co';
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwbWRneWd1cHV6dGhxeGZpcHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDU0MjYsImV4cCI6MjA3NDk4MTQyNn0.JdOoMgW7oXtHycvJGl9buYagZaGXoqkU9rF0KnTNKX4';
const SITE_URL = "https://luxexpose.com";

// Pagination setup
const page = Astro.url.searchParams.get('page') ? parseInt(Astro.url.searchParams.get('page')!) : 1;
const articlesPerPage = 33;
const offset = (page - 1) * articlesPerPage;

let featuredArticles: any[] = [];
let editorialArticles: any[] = [];
let totalPages = 1;

try {
  // Fetch featured articles for hero slider (5 articles)
  // Try with categories relationship first
  const featuredResponse = await fetch(
    `${SUPABASE_URL}/rest/v1/articles?select=id,title,slug,excerpt,featured_image,published_at,featured_video_url,categories(name)&status=eq.published&order=published_at.desc&limit=5`,
    {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
      },
    }
  );
  
  if (featuredResponse.ok) {
    const data = await featuredResponse.json();
    featuredArticles = Array.isArray(data) ? data : [];
    console.log(`[index.astro] Fetched ${featuredArticles.length} featured articles for slider`);
    
    // If no articles, try without categories relationship
    if (featuredArticles.length === 0) {
      console.log('[index.astro] No articles with categories, trying without relationship...');
      const fallbackResponse = await fetch(
        `${SUPABASE_URL}/rest/v1/articles?select=id,title,slug,excerpt,featured_image,published_at,featured_video_url&status=eq.published&order=published_at.desc&limit=5`,
        {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      if (fallbackResponse.ok) {
        featuredArticles = await fallbackResponse.json();
        console.log(`[index.astro] Fallback: Fetched ${featuredArticles.length} articles`);
      }
    }
  } else {
    console.error('[index.astro] Featured articles fetch failed:', featuredResponse.status, featuredResponse.statusText);
    const errorText = await featuredResponse.text();
    console.error('[index.astro] Error details:', errorText);
  }

  // Get total count of non-featured articles for pagination
  const countResponse = await fetch(
    `${SUPABASE_URL}/rest/v1/articles?status=eq.published&featured=eq.false&select=id`,
    {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Prefer': 'count=exact'
      }
    }
  );
  
  let totalArticles = 0;
  if (countResponse.ok) {
    const contentRange = countResponse.headers.get('content-range');
    if (contentRange) {
      const match = contentRange.match(/\/(\d+)/);
      if (match) {
        totalArticles = parseInt(match[1], 10);
      }
    }
    totalPages = Math.ceil(totalArticles / articlesPerPage);
  }

  // Fetch editorial articles (non-featured, with pagination)
  // Try with categories relationship first
  let editorialResponse = await fetch(
    `${SUPABASE_URL}/rest/v1/articles?status=eq.published&featured=eq.false&select=id,title,slug,featured_image,excerpt,published_at,created_at,categories(name)&order=published_at.desc&offset=${offset}&limit=${articlesPerPage}`,
    {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
      },
    }
  );
  
  if (editorialResponse.ok) {
    const data = await editorialResponse.json();
    editorialArticles = Array.isArray(data) ? data : [];
    console.log(`[index.astro] Fetched ${editorialArticles.length} editorial articles (page ${page})`);
    
    // If no articles with categories, try without relationship
    if (editorialArticles.length === 0) {
      console.log('[index.astro] No editorial articles with categories, trying without relationship...');
      editorialResponse = await fetch(
        `${SUPABASE_URL}/rest/v1/articles?status=eq.published&featured=eq.false&select=id,title,slug,featured_image,excerpt,published_at,created_at&order=published_at.desc&offset=${offset}&limit=${articlesPerPage}`,
        {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
          },
        }
      );
      
      if (editorialResponse.ok) {
        editorialArticles = await editorialResponse.json();
        console.log(`[index.astro] Fallback: Fetched ${editorialArticles.length} editorial articles`);
      }
    }
  } else {
    console.error('[index.astro] Editorial articles fetch failed:', editorialResponse.status, editorialResponse.statusText);
    const errorText = await editorialResponse.text();
    console.error('[index.astro] Error details:', errorText);
  }
} catch (error) {
  console.error('Failed to fetch articles:', error);
  featuredArticles = [];
  editorialArticles = [];
}

const homeTitle = "Lux Exposé — Luxury Editorial, Travel, Autos, Real Estate";
const homeDesc =
  "Luxury editorial featuring world-class travel, horology, automotive icons, exceptional real estate, and exclusive experiences.";
const canonicalUrl = `${SITE_URL}/`;
---

<Layout>
  <span slot="title">{homeTitle}</span>

  <meta slot="head" name="description" content={homeDesc} />
  <link slot="head" rel="canonical" href={canonicalUrl} />

  <!-- Open Graph -->
  <meta slot="head" property="og:title" content={homeTitle} />
  <meta slot="head" property="og:description" content={homeDesc} />
  <meta slot="head" property="og:url" content={canonicalUrl} />
  <meta slot="head" property="og:type" content="website" />
  <meta slot="head" property="og:site_name" content="Lux Exposé" />

  <!-- Twitter -->
  <meta slot="head" name="twitter:card" content="summary_large_image" />
  <meta slot="head" name="twitter:title" content={homeTitle} />
  <meta slot="head" name="twitter:description" content={homeDesc} />

  <Navbar />

  <!-- Spacer to account for fixed navbar height -->
  <div class="navbar-spacer"></div>

  <div class="relative bg-glass-option-9 overflow-hidden min-h-screen">
    <!-- Let HeroSlider fetch articles automatically if none provided -->
        <HeroSlider articles={featuredArticles.length > 0 ? featuredArticles : undefined} fetchArticles={featuredArticles.length === 0} />
        <PlatformPillars />
        <FeaturedBrandsMarquee />
        <LuxuryQuotes />
        <BeyondTheEditorial />
        <EditorialGrid articles={editorialArticles} currentPage={page} totalPages={totalPages} />
  </div>

  <Footer />
</Layout>