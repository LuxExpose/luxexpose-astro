---
import { supabase } from "../lib/supabase";

export const prerender = false;

// Fetch latest published articles from the view
const { data: articles, error } = await supabase
  .from("public_articles")
  .select("title, slug, excerpt, featured_image, published_at")
  .order("published_at", { ascending: false })
  .limit(24);

if (error) console.error(error);

const siteUrl = import.meta.env.SITE_URL ?? "https://luxexpose-astro.vercel.app";
const pageTitle = "Lux Exposé";
const pageDescription =
  "Luxury lifestyle stories, travel, watches, spirits, style, and experiences — curated by Lux Exposé.";

const ogImage =
  "https://luxexpose.com/wp-content/uploads/2023/08/LuxExpose-Logo.png";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{pageTitle}</title>

    <meta name="description" content={pageDescription} />

    <!-- Open Graph -->
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:url" content={`${siteUrl}/`} />
    <meta property="og:type" content="website" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImage} />

    <style>
      :root{
        --bg:#070709;
        --panel:#0f0f14;
        --text:#f2f2f3;
        --muted:#a9a9b2;
        --gold:#c8a24b;
        --border:rgba(255,255,255,.08);
        --shadow: 0 10px 30px rgba(0,0,0,.35);
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 30% -10%, rgba(200,162,75,.18), transparent 60%),
                    radial-gradient(900px 500px at 90% 0%, rgba(255,255,255,.06), transparent 55%),
                    var(--bg);
        color:var(--text);
      }
      a{color:inherit;text-decoration:none}
      .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 70px}
      .topbar{
        display:flex;align-items:center;justify-content:space-between;
        gap:14px;margin-bottom:22px;
      }
      .brand{
        display:flex;align-items:baseline;gap:10px;
        letter-spacing:.06em;
      }
      .brand b{font-size:18px}
      .brand span{font-size:12px;color:var(--muted)}
      .pill{
        border:1px solid var(--border);
        background:rgba(255,255,255,.04);
        padding:10px 12px;border-radius:999px;
        color:var(--muted);font-size:13px;
      }
      .hero{
        border:1px solid var(--border);
        background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
        border-radius:18px;
        padding:26px;
        box-shadow: var(--shadow);
        margin-bottom:20px;
      }
      .hero h1{
        margin:0 0 10px;
        font-size:34px;
        line-height:1.1;
        letter-spacing:-.02em;
      }
      .hero p{margin:0;color:var(--muted);max-width:760px}
      .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
      .btn{
        display:inline-flex;align-items:center;gap:10px;
        border:1px solid var(--border);
        background:rgba(255,255,255,.04);
        padding:10px 14px;border-radius:12px;
        font-weight:600;font-size:13px;
      }
      .btnPrimary{
        border-color:rgba(200,162,75,.35);
        background:rgba(200,162,75,.14);
        color:var(--text);
      }
      .btnPrimary i{
        width:8px;height:8px;border-radius:50%;
        background:var(--gold);display:inline-block;
        box-shadow:0 0 0 3px rgba(200,162,75,.18);
      }

      .grid{
        display:grid;
        grid-template-columns: repeat(12, 1fr);
        gap:14px;
        margin-top:18px;
      }
      .card{
        grid-column: span 4;
        border:1px solid var(--border);
        background: rgba(255,255,255,.03);
        border-radius:16px;
        overflow:hidden;
        box-shadow: 0 8px 18px rgba(0,0,0,.25);
        transition: transform .15s ease, border-color .15s ease;
      }
      .card:hover{transform: translateY(-2px); border-color: rgba(200,162,75,.28);}
      .thumb{
        width:100%;
        aspect-ratio: 16/10;
        background: rgba(255,255,255,.06);
        overflow:hidden;
      }
      .thumb img{width:100%;height:100%;object-fit:cover;display:block}
      .cardBody{padding:14px 14px 16px}
      .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;margin-bottom:8px}
      .dot{width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.25)}
      .title{
        margin:0 0 10px;
        font-size:15px;
        line-height:1.25;
        letter-spacing:-.01em;
      }
      .excerpt{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
      .footer{
        margin-top:26px;
        color:var(--muted);
        font-size:12px;
        opacity:.9;
      }

      @media (max-width: 980px){
        .card{grid-column: span 6;}
      }
      @media (max-width: 560px){
        .hero h1{font-size:28px}
        .card{grid-column: span 12;}
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <b>Lux Exposé</b>
          <span>Astro SSR • SEO-first</span>
        </div>
        <div class="pill">Latest stories</div>
      </div>

      <section class="hero">
        <h1>Luxury stories that share perfectly.</h1>
        <p>
          This homepage pulls directly from your Lovable/Supabase content. Every article page renders real HTML,
          with proper Open Graph for Facebook, iMessage, LinkedIn, and X.
        </p>

        <div class="ctaRow">
          <a class="btn btnPrimary" href="/test"><i></i>OG Test Page</a>
          <a class="btn" href="/four-seasons-seoul-unveils-hublot-inspired-art-and-cocktails-for-the-holidays">Open a sample article</a>
        </div>
      </section>

      {error && (
        <p class="pill" style="border-color: rgba(255,0,0,.25);">
          Error loading articles. Check Vercel env vars + Supabase view permissions.
        </p>
      )}

      <section class="grid">
        {(articles ?? []).map((a) => (
          <a class="card" href={`/${a.slug}`}>
            <div class="thumb">
              {a.featured_image ? (
                <img src={a.featured_image} alt={a.title} loading="lazy" />
              ) : (
                <div style="height:100%;display:grid;place-items:center;color:rgba(255,255,255,.35);font-size:12px;">
                  No image
                </div>
              )}
            </div>
            <div class="cardBody">
              <div class="meta">
                <span>Story</span>
                <span class="dot"></span>
                <span>{a.published_at ? new Date(a.published_at).toLocaleDateString() : "—"}</span>
              </div>
              <h2 class="title">{a.title}</h2>
              {a.excerpt && <p class="excerpt">{a.excerpt}</p>}
            </div>
          </a>
        ))}
      </section>

      <div class="footer">
        Next: we’ll match LuxExpose.com styling, add categories, search, and sections (Travel / Watches / Spirits / Style).
      </div>
    </div>
  </body>
</html>