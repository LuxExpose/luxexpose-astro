---
interface Location {
  name: string;
  lat: number;
  lng: number;
  type?: string;
}

interface Props {
  cityName: string;
  centerLat: number;
  centerLng: number;
  zoom?: number;
  locations?: Location[];
}

const { cityName, centerLat, centerLng, zoom = 12, locations = [] } = Astro.props;
---

<section class="w-full">
  <div class="mb-6">
    <h2 class="font-serif text-3xl md:text-4xl text-white mb-2">
      Explore {cityName}
    </h2>
    <p class="text-white/70">
      Discover luxury experiences and destinations
    </p>
  </div>

  <div class="w-full h-[400px] md:h-[500px] rounded-xl overflow-hidden border border-white/10 bg-black/40">
    <div id={`map-${cityName.toLowerCase().replace(/\s+/g, "-")}`} class="w-full h-full">
      <!-- Map will be initialized client-side -->
      <div class="w-full h-full flex items-center justify-center text-white/50">
        <p>Map loading...</p>
      </div>
    </div>
  </div>

  <!-- Load Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  
  <!-- Load Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>

  <!-- Initialize map after Leaflet loads -->
  <script define:vars={{ cityName, centerLat, centerLng, zoom, locations }} is:inline>
    (function() {
      // Wait for Leaflet to load (from CDN)
      function initMap() {
        if (typeof window.L === 'undefined') {
          setTimeout(initMap, 50);
          return;
        }
        
        const mapId = `map-${cityName.toLowerCase().replace(/\s+/g, "-")}`;
        const mapElement = document.getElementById(mapId);
        if (!mapElement) return;
        
        try {
          const map = window.L.map(mapId).setView([centerLat, centerLng], zoom);
          
          window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          }).addTo(map);

          // Add markers for locations
          if (locations && Array.isArray(locations) && locations.length > 0) {
            locations.forEach((location) => {
              if (location && location.lat && location.lng) {
                window.L.marker([location.lat, location.lng])
                  .addTo(map)
                  .bindPopup(location.name || 'Location');
              }
            });
          }
        } catch (error) {
          console.error('Error initializing map:', error);
        }
      }
      
      // Start initialization when DOM and Leaflet are ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(initMap, 100);
        });
      } else {
        setTimeout(initMap, 100);
      }
    })();
  </script>
</section>

