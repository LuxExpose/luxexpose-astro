---
// src/components/Navbar.astro
import '../styles/navbar.css';
import { cities } from '../data/cities';

// Fetch categories from Supabase at build time
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || 'https://ppmdgygupuzthqxfippv.supabase.co';
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwbWRneWd1cHV6dGhxeGZpcHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDU0MjYsImV4cCI6MjA3NDk4MTQyNn0.JdOoMgW7oXtHycvJGl9buYagZaGXoqkU9rF0KnTNKX4';

let categories: Array<{ id: string; name: string; slug: string; article_count: number }> = [];

try {
  const response = await fetch(
    `${supabaseUrl}/rest/v1/categories?select=id,name,slug,articles!inner(id)&articles.status=eq.published&order=name`,
    {
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`,
      },
    }
  );
  
  if (response.ok) {
    const data = await response.json();
    const categoryMap = new Map();
    
    data.forEach((cat: any) => {
      if (!categoryMap.has(cat.id)) {
        categoryMap.set(cat.id, {
          id: cat.id,
          name: cat.name,
          slug: cat.slug,
          article_count: 0,
        });
      }
      if (cat.articles?.id) {
        categoryMap.get(cat.id).article_count++;
      }
    });
    
    categories = Array.from(categoryMap.values()).filter((cat) => cat.article_count > 0);
  }
} catch (error) {
  console.error('Failed to fetch categories:', error);
}
---

<nav class="navbar" id="navbar">
  <!-- Top Utility Bar -->
  <div class="utility-bar">
    <div class="nav-container">
      <div class="utility-bar-content">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <!-- Theme Toggle -->
          <button class="utility-btn" id="theme-toggle" aria-label="Toggle theme">
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
          </button>
          
          <!-- Search Button -->
          <button class="utility-btn" id="search-btn" aria-label="Search" onclick="window.location.href='/search'">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Navigation -->
  <div class="nav-container">
    <div class="main-nav">
      <!-- Logo -->
      <a href="/" class="logo-link">
        <img src="/images/lux-logo.png" alt="Lux Exposé Logo" class="logo-image" />
        <div class="logo-text">
          <span class="logo-lux">LUX</span>
          <span class="logo-expose">EXPOSÉ</span>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <nav class="desktop-nav" aria-label="Main navigation">
        <ul class="nav-list">
          <!-- Cities Dropdown -->
          <li class="nav-item">
            <button class="nav-trigger" data-dropdown="cities">
              CITIES
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <div class="dropdown glass-card-menu dropdown-cities" id="dropdown-cities">
              <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                {cities.map((city) => (
                  <a href={city.path} class="city-item">
                    <h3 class="city-name">{city.name}</h3>
                    <p class="city-description">{city.description}</p>
                  </a>
                ))}
              </div>
            </div>
          </li>

          <!-- Experiences -->
          <li class="nav-item">
            <a href="/experiences" class="nav-link">EXPERIENCES</a>
          </li>

          <!-- Editorial -->
          <li class="nav-item">
            <a href="/editorial" class="nav-link">EDITORIAL</a>
          </li>

          <!-- Categories Dropdown -->
          {categories.length > 0 && (
            <li class="nav-item">
              <button class="nav-trigger" data-dropdown="categories">
                CATEGORIES
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
              </button>
              <div class="dropdown glass-card-menu dropdown-categories" id="dropdown-categories">
                <div class="categories-grid">
                  {categories.map((cat) => (
                    <a href={`/category/${cat.slug}`} class="category-item">
                      <div class="category-name">{cat.name}</div>
                      <div class="category-count">{cat.article_count} articles</div>
                    </a>
                  ))}
                </div>
              </div>
            </li>
          )}

          <!-- Community -->
          <li class="nav-item">
            <a href="/community-info" class="nav-link">COMMUNITY</a>
          </li>
        </ul>
      </nav>

      <!-- Right Actions (Desktop) -->
      <div class="right-actions">
        <!-- Concierge Button -->
        <a href="/concierge" class="btn-luxury">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
          <span class="btn-text">Concierge</span>
        </a>
        
        <!-- Sign In (placeholder) -->
        <a href="/auth" class="user-menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Sign In
        </a>
      </div>

      <!-- Mobile Actions -->
      <div class="mobile-actions">
        <a href="/concierge" class="btn-luxury">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
        </a>
        
        <button class="utility-btn" id="mobile-search-btn" aria-label="Search" onclick="window.location.href='/search'">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </button>
        
        <button class="mobile-menu-btn" id="mobile-menu-toggle" aria-label="Toggle menu">
          <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
          <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobile-menu">
      <!-- Mobile Search -->
      <button class="mobile-search-btn" id="mobile-search-trigger" onclick="window.location.href='/search'">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <span>Search site</span>
      </button>

      <!-- Quick Links -->
      <div class="mobile-quick-links">
        <a href="/concierge" class="mobile-quick-link primary">Contact Concierge</a>
      </div>

      <!-- Cities Section -->
      <div class="mobile-accordion">
        <button class="mobile-accordion-trigger" data-accordion="mobile-cities">
          CITIES
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        </button>
        <div class="mobile-accordion-content" id="mobile-cities" style="display: none;">
          {cities.map((city) => (
            <a href={city.path} style="display: block; padding: 0.5rem 0; font-size: 0.875rem; color: hsl(var(--foreground)); text-decoration: none;">
              {city.name}
            </a>
          ))}
        </div>
      </div>

      <!-- Experiences -->
      <a href="/experiences" class="mobile-nav-link">EXPERIENCES</a>

      <!-- Editorial -->
      <a href="/editorial" class="mobile-nav-link">EDITORIAL</a>

      <!-- Categories Section -->
      {categories.length > 0 && (
        <div class="mobile-accordion">
          <button class="mobile-accordion-trigger" data-accordion="mobile-categories">
            CATEGORIES
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
          </button>
          <div class="mobile-accordion-content" id="mobile-categories" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
              {categories.map((cat) => (
                <a href={`/category/${cat.slug}`} style="display: block; padding: 0.5rem 0.75rem; border-radius: 0.375rem; background: hsl(var(--muted)); font-size: 0.875rem; text-decoration: none;">
                  <div style="font-weight: 500; color: hsl(var(--foreground));">{cat.name}</div>
                  <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">{cat.article_count} articles</div>
                </a>
              ))}
            </div>
          </div>
        </div>
      )}

      <!-- Community -->
      <a href="/community-info" class="mobile-nav-link">COMMUNITY</a>

      <!-- Theme Toggle -->
      <div class="mobile-theme-section">
        <button class="mobile-theme-btn" id="mobile-theme-toggle">
          <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
          <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
          <span class="theme-text">Light Mode</span>
        </button>
      </div>
    </div>
  </div>
</nav>

<script is:inline>
  // Scroll detection
  const navbar = document.getElementById('navbar');
  window.addEventListener('scroll', () => {
    if (window.scrollY > 20) {
      navbar?.classList.add('scrolled');
    } else {
      navbar?.classList.remove('scrolled');
    }
  }, { passive: true });

  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = mobileMenuToggle?.querySelector('.menu-icon') as HTMLElement;
  const closeIcon = mobileMenuToggle?.querySelector('.close-icon') as HTMLElement;

  mobileMenuToggle?.addEventListener('click', () => {
    const isOpen = mobileMenu?.classList.toggle('open');
    if (menuIcon && closeIcon) {
      menuIcon.style.display = isOpen ? 'none' : 'block';
      closeIcon.style.display = isOpen ? 'block' : 'none';
    }
    document.body.style.overflow = isOpen ? 'hidden' : '';
  });

  // Dropdown toggles
  const dropdownTriggers = document.querySelectorAll('[data-dropdown]');
  dropdownTriggers.forEach((trigger) => {
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdownId = (trigger as HTMLElement).dataset.dropdown;
      const dropdown = document.getElementById(`dropdown-${dropdownId}`);
      
      // Close other dropdowns
      document.querySelectorAll('.dropdown').forEach((d) => {
        if (d !== dropdown) d.classList.remove('open');
      });
      document.querySelectorAll('[data-dropdown]').forEach((t) => {
        if (t !== trigger) t.setAttribute('data-state', 'closed');
      });
      
      dropdown?.classList.toggle('open');
      trigger.setAttribute('data-state', dropdown?.classList.contains('open') ? 'open' : 'closed');
    });
  });

  // Close dropdowns on outside click
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (!target.closest('[data-dropdown]') && !target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown').forEach((d) => d.classList.remove('open'));
      dropdownTriggers.forEach((t) => t.setAttribute('data-state', 'closed'));
    }
  });

  // Accordion toggles
  const accordionTriggers = document.querySelectorAll('[data-accordion]');
  accordionTriggers.forEach((trigger) => {
    trigger.addEventListener('click', () => {
      const accordionId = (trigger as HTMLElement).dataset.accordion;
      const content = document.getElementById(accordionId || '');
      if (!content) return;
      
      const isOpen = content.style.display === 'block';
      
      content.style.display = isOpen ? 'none' : 'block';
      trigger.setAttribute('data-state', isOpen ? 'closed' : 'open');
    });
  });

  // Theme toggle
  const themeToggle = document.getElementById('theme-toggle');
  const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
  
  const updateThemeIcons = () => {
    const isDark = document.documentElement.classList.contains('dark') || !document.documentElement.classList.contains('light');
    document.querySelectorAll('.sun-icon').forEach((icon) => {
      (icon as HTMLElement).style.display = isDark ? 'block' : 'none';
    });
    document.querySelectorAll('.moon-icon').forEach((icon) => {
      (icon as HTMLElement).style.display = isDark ? 'none' : 'block';
    });
    document.querySelectorAll('.theme-text').forEach((text) => {
      text.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    });
  };

  const toggleTheme = () => {
    const isDark = document.documentElement.classList.contains('dark') || !document.documentElement.classList.contains('light');
    if (isDark) {
      document.documentElement.classList.remove('dark');
      document.documentElement.classList.add('light');
      localStorage.setItem('theme', 'light');
    } else {
      document.documentElement.classList.remove('light');
      document.documentElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    }
    updateThemeIcons();
  };

  themeToggle?.addEventListener('click', toggleTheme);
  mobileThemeToggle?.addEventListener('click', toggleTheme);

  // Initialize theme
  const savedTheme = localStorage.getItem('theme') || 'dark';
  if (savedTheme === 'light') {
    document.documentElement.classList.add('light');
  } else {
    document.documentElement.classList.add('dark');
  }
  updateThemeIcons();
</script>

<style>
  .dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.5rem;
    z-index: 100;
  }
  
  .dropdown.open {
    display: block;
  }
  
  .nav-item {
    position: relative;
    list-style: none;
  }
</style>
