---
/**
 * Navbar Component - Homepage
 * Complete implementation based on Lovable specifications
 */

import { fetchCategories } from "../utils/categories";
import { cities } from "../data/cities";

// Fetch categories from Supabase
const categories = await fetchCategories();
const displayCategories = categories.slice(0, 8); // Show first 8 categories in EDITORIAL dropdown
const additionalCategories = categories.slice(8); // Remaining categories for CATEGORIES dropdown
---

<nav class="navbar sticky top-0 z-50 bg-background/85 backdrop-blur-md border-b border-border transition-all duration-500" id="mainNavbar">
  <!-- Top Utility Bar (hidden on mobile) -->
  <div class="utility-bar hidden md:block">
    <div class="utility-bar-content">
      <div class="flex items-center gap-2">
          <!-- Theme Toggle -->
          <button 
            class="utility-btn h-8 w-8 inline-flex items-center justify-center rounded-md text-muted-foreground hover:text-foreground hover:bg-muted/50 transition-colors"
            aria-label="Toggle theme"
            type="button"
            data-theme-toggle
          >
            <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </button>
          
          <!-- Search Button -->
          <button 
            class="utility-btn h-8 w-8 inline-flex items-center justify-center rounded-md text-muted-foreground hover:text-foreground hover:bg-muted/50 transition-colors"
            aria-label="Search"
            type="button"
            onclick="window.location.href='/search'"
          >
            <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
          
          <!-- Messages Icon (placeholder - show if authenticated) -->
          <a 
            href="/messages" 
            class="utility-btn relative h-8 w-8 inline-flex items-center justify-center rounded-md text-muted-foreground hover:text-foreground hover:bg-muted/50 transition-colors"
            aria-label="Messages"
          >
            <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <!-- Unread badge (hidden for now - show when count > 0) -->
            <!-- <span class="notification-badge pulse">3</span> -->
          </a>
          
          <!-- Notifications Bell -->
          <button 
            class="utility-btn relative h-8 w-8 inline-flex items-center justify-center rounded-md text-muted-foreground hover:text-foreground hover:bg-muted/50 transition-colors"
            aria-label="Notifications"
            type="button"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0018 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <!-- Unread badge (hidden for now - show when count > 0) -->
            <!-- <span class="notification-badge destructive">5</span> -->
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Navigation -->
  <div class="nav-container">
    <div class="nav-content">
      
      <!-- Logo -->
      <a href="/" class="logo-link">
        <img 
          src="/images/lux-logo.png" 
          alt="Lux Exposé Logo" 
          class="logo-image"
          loading="eager"
        />
        <div class="logo-text">
          <span class="logo-lux">LUX</span>
          <span class="logo-expose">EXPOSÉ</span>
        </div>
      </a>
      
      <!-- Desktop Navigation (hidden lg:flex) -->
      <nav class="desktop-nav">
        <ul class="nav-list">
          <!-- CITIES Dropdown -->
          <li class="nav-item has-dropdown" data-dropdown>
            <button class="nav-trigger" data-dropdown-trigger>
              CITIES
              <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="dropdown-content glass-card-menu dropdown-cities" data-dropdown-content>
              {cities.map((city) => (
                <a class="dropdown-item" href={city.path}>
                  <h3>{city.name}</h3>
                  <p>{city.description}</p>
                </a>
              ))}
            </div>
          </li>

          <!-- EXPERIENCES Dropdown -->
          <li class="nav-item has-dropdown" data-dropdown>
            <button class="nav-trigger" data-dropdown-trigger>
              EXPERIENCES
              <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="dropdown-content glass-card-menu dropdown-editorial" data-dropdown-content>
              <a class="dropdown-item" href="/experiences">
                <h3>All Experiences</h3>
                <p>Browse luxury experiences</p>
              </a>
            </div>
          </li>

          <!-- EDITORIAL Dropdown -->
          <li class="nav-item has-dropdown" data-dropdown>
            <button class="nav-trigger" data-dropdown-trigger>
              EDITORIAL
              <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            {displayCategories.length > 0 && (
              <div class="dropdown-content glass-card-menu dropdown-editorial" data-dropdown-content>
                {displayCategories.map((category) => (
                  <a class="dropdown-item" href={`/category/${category.slug}`}>
                    <h3>{category.name}</h3>
                    {category.article_count && (
                      <p>{category.article_count} articles</p>
                    )}
                  </a>
                ))}
                <a class="dropdown-item" href="/editorial">
                  <h3>View All Editorial</h3>
                  <p>Browse all articles</p>
                </a>
              </div>
            )}
          </li>

          <!-- CATEGORIES Dropdown (additional categories) -->
          {additionalCategories.length > 0 && (
            <li class="nav-item has-dropdown" data-dropdown>
              <button class="nav-trigger" data-dropdown-trigger>
                CATEGORIES
                <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="dropdown-content glass-card-menu dropdown-categories" data-dropdown-content>
                {additionalCategories.map((category) => (
                  <a class="dropdown-item" href={`/category/${category.slug}`}>
                    <h3>{category.name}</h3>
                    {category.article_count && (
                      <p>{category.article_count} articles</p>
                    )}
                  </a>
                ))}
              </div>
            </li>
          )}

          <!-- COMMUNITY Link -->
          <li class="nav-item">
            <a href="/community" class="nav-link">COMMUNITY</a>
          </li>
        </ul>
      </nav>
      
      <!-- Right Actions - Desktop -->
      <div class="hidden md:flex items-center gap-2 lg:gap-3">
        <!-- Concierge Button -->
        <a href="/concierge" class="btn-luxury">
          <svg class="concierge-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <span class="concierge-text">Concierge</span>
        </a>
        
        <!-- User Menu (placeholder - implement when auth is ready) -->
        <!-- <div class="user-menu">...</div> -->
      </div>
      
      <!-- Right Actions - Mobile -->
      <div class="flex md:hidden items-center gap-1">
        <!-- Concierge Button -->
        <a href="/concierge" class="btn-luxury">
          <svg class="concierge-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        </a>
        
        <!-- Search Button -->
        <button 
          class="utility-btn h-8 w-8"
          aria-label="Search"
          onclick="window.location.href='/search'"
        >
          <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
        
        <!-- Mobile Menu Toggle -->
        <button 
          class="utility-btn h-8 w-8" 
          aria-label="Toggle menu"
          aria-expanded="false"
          data-menu-toggle
          type="button"
        >
          <svg class="h-[18px] w-[18px] menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <svg class="h-[18px] w-[18px] close-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="mobile-menu" data-mobile-menu>
    <div class="mobile-menu-content">
      <!-- Mobile Search Button -->
      <a href="/search" class="mobile-search-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <span>Search</span>
      </a>

      <!-- Mobile Navigation Links -->
      <div class="mt-4 space-y-1">
        <!-- CITIES Accordion -->
        <div class="mobile-accordion">
          <button class="mobile-accordion-trigger" data-accordion="cities" type="button">
            <span>CITIES</span>
            <svg class="w-4 h-4 accordion-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="mobile-accordion-content" data-accordion-content="cities">
            {cities.map((city) => (
              <a href={city.path} class="mobile-nav-link" data-close-mobile>
                {city.name}
              </a>
            ))}
          </div>
        </div>

        <!-- EXPERIENCES -->
        <a href="/experiences" class="mobile-nav-link" data-close-mobile>EXPERIENCES</a>

        <!-- EDITORIAL Accordion -->
        <div class="mobile-accordion">
          <button class="mobile-accordion-trigger" data-accordion="editorial" type="button">
            <span>EDITORIAL</span>
            <svg class="w-4 h-4 accordion-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="mobile-accordion-content" data-accordion-content="editorial">
            {displayCategories.map((category) => (
              <a href={`/category/${category.slug}`} class="mobile-nav-link" data-close-mobile>
                {category.name}
                {category.article_count && (
                  <span class="text-muted-foreground ml-2">({category.article_count})</span>
                )}
              </a>
            ))}
            <a href="/editorial" class="mobile-nav-link" data-close-mobile>View All Editorial</a>
          </div>
        </div>

        <!-- CATEGORIES Accordion (if additional categories exist) -->
        {additionalCategories.length > 0 && (
          <div class="mobile-accordion">
            <button class="mobile-accordion-trigger" data-accordion="categories" type="button">
              <span>CATEGORIES</span>
              <svg class="w-4 h-4 accordion-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="mobile-accordion-content" data-accordion-content="categories">
              {additionalCategories.map((category) => (
                <a href={`/category/${category.slug}`} class="mobile-nav-link" data-close-mobile>
                  {category.name}
                  {category.article_count && (
                    <span class="text-muted-foreground ml-2">({category.article_count})</span>
                  )}
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- COMMUNITY -->
        <a href="/community" class="mobile-nav-link" data-close-mobile>COMMUNITY</a>
      </div>
    </div>
  </div>
</nav>

<script is:inline>
  // Scroll detection for shadow
  document.addEventListener('DOMContentLoaded', () => {
    const navbar = document.getElementById('mainNavbar');
    
    if (navbar) {
      window.addEventListener('scroll', () => {
        if (window.scrollY > 20) {
          navbar.classList.add('scrolled');
        } else {
          navbar.classList.remove('scrolled');
        }
      }, { passive: true });
      
      // Check initial state
      if (window.scrollY > 20) {
        navbar.classList.add('scrolled');
      }
    }
  });

  // Mobile menu toggle
  (function() {
    const menuToggle = document.querySelector('[data-menu-toggle]');
    const mobileMenu = document.querySelector('[data-mobile-menu]');
    const menuIcon = menuToggle?.querySelector('.menu-icon');
    const closeIcon = menuToggle?.querySelector('.close-icon');
    const body = document.body;

    menuToggle?.addEventListener('click', () => {
      const isOpen = mobileMenu?.classList.contains('open');
      
      if (isOpen) {
        mobileMenu?.classList.remove('open');
        menuToggle.setAttribute('aria-expanded', 'false');
        body.classList.remove('overflow-hidden');
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
      } else {
        mobileMenu?.classList.add('open');
        menuToggle.setAttribute('aria-expanded', 'true');
        body.classList.add('overflow-hidden');
        menuIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
      }
    });

    // Close mobile menu when clicking links
    document.querySelectorAll('[data-close-mobile]').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu?.classList.remove('open');
        menuToggle?.setAttribute('aria-expanded', 'false');
        body.classList.remove('overflow-hidden');
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
      });
    });

    // Close mobile menu on outside click
    document.addEventListener('click', (e) => {
      if (mobileMenu?.classList.contains('open')) {
        const target = e.target as HTMLElement;
        const clickedInside = mobileMenu.contains(target) || menuToggle?.contains(target);
        if (!clickedInside) {
          mobileMenu.classList.remove('open');
          menuToggle?.setAttribute('aria-expanded', 'false');
          body.classList.remove('overflow-hidden');
          menuIcon?.classList.remove('hidden');
          closeIcon?.classList.add('hidden');
        }
      }
    });

    // Close on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileMenu?.classList.contains('open')) {
        mobileMenu.classList.remove('open');
        menuToggle?.setAttribute('aria-expanded', 'false');
        body.classList.remove('overflow-hidden');
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
      }
    });
  })();

  // Theme toggle
  (function() {
    const themeToggle = document.querySelector('[data-theme-toggle]');
    
    themeToggle?.addEventListener('click', () => {
      const html = document.documentElement;
      const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.classList.remove(currentTheme);
      html.classList.add(newTheme);
      localStorage.setItem('theme', newTheme);
    });

    // Initialize theme from localStorage
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.classList.add(savedTheme);
  })();

  // Dropdown functionality
  (function() {
    const dropdowns = document.querySelectorAll('[data-dropdown]');
    
    dropdowns.forEach(dropdown => {
      const trigger = dropdown.querySelector('[data-dropdown-trigger]');
      const content = dropdown.querySelector('[data-dropdown-content]');
      
      if (!trigger || !content) return;

      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = content.classList.contains('open');
        
        // Close all other dropdowns
        document.querySelectorAll('[data-dropdown-content].open').forEach(d => {
          d.classList.remove('open');
          d.previousElementSibling?.setAttribute('data-state', 'closed');
        });
        
        if (!isOpen) {
          content.classList.add('open');
          trigger.setAttribute('data-state', 'open');
        } else {
          content.classList.remove('open');
          trigger.setAttribute('data-state', 'closed');
        }
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('[data-dropdown]')) {
        document.querySelectorAll('[data-dropdown-content].open').forEach(d => {
          d.classList.remove('open');
          const trigger = d.previousElementSibling;
          if (trigger) trigger.setAttribute('data-state', 'closed');
        });
      }
    });
  })();

  // Mobile accordion functionality
  (function() {
    const accordions = document.querySelectorAll('[data-accordion]');
    
    accordions.forEach(button => {
      button.addEventListener('click', () => {
        const key = button.getAttribute('data-accordion');
        const content = document.querySelector(`[data-accordion-content="${key}"]`);
        const icon = button.querySelector('.accordion-icon');
        
        if (!content) return;

        const isOpen = content.classList.contains('open');
        
        // Close all other accordions
        document.querySelectorAll('[data-accordion-content].open').forEach(acc => {
          acc.classList.remove('open');
          acc.style.maxHeight = '0';
        });
        document.querySelectorAll('.accordion-icon').forEach(ic => {
          ic.style.transform = 'rotate(0deg)';
        });

        if (!isOpen) {
          content.classList.add('open');
          content.style.maxHeight = content.scrollHeight + 'px';
          if (icon) icon.style.transform = 'rotate(180deg)';
        } else {
          content.classList.remove('open');
          content.style.maxHeight = '0';
          if (icon) icon.style.transform = 'rotate(0deg)';
        }
      });
    });
  })();
</script>

<style>
  /* Additional mobile accordion styles */
  .mobile-accordion {
    border-bottom: 1px solid hsl(var(--border));
  }

  .mobile-accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .mobile-accordion-content.open {
    max-height: 1000px;
  }

  .accordion-icon {
    transition: transform 0.3s ease;
  }
</style>
