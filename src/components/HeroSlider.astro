---
import { getYouTubeVideoId, getYouTubeEmbedUrl } from '../utils/youtube';

// Props interface
interface Article {
  id: string;
  title: string;
  slug: string;
  excerpt?: string;
  featured_image?: string;
  published_at?: string;
  featured_video_url?: string;
  categories?: {
    name: string;
  };
}

interface Props {
  articles?: Article[];
  fetchArticles?: boolean;
  limit?: number;
}

const { articles: providedArticles, fetchArticles = false, limit = 5 } = Astro.props;

// Fetch articles if none provided or if fetchArticles is true
const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL || 'https://ppmdgygupuzthqxfippv.supabase.co';
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwbWRneWd1cHV6dGhxeGZpcHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDU0MjYsImV4cCI6MjA3NDk4MTQyNn0.JdOoMgW7oXtHycvJGl9buYagZaGXoqkU9rF0KnTNKX4';

let articles: Article[] = providedArticles || [];

// Fetch articles if needed
if (fetchArticles || articles.length === 0) {
  try {
    // Try with categories relationship first
    let response = await fetch(
      `${SUPABASE_URL}/rest/v1/articles?select=id,title,slug,excerpt,featured_image,published_at,featured_video_url,categories(name)&status=eq.published&order=published_at.desc&limit=${limit}`,
      {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
        },
      }
    );
    
    if (response.ok) {
      const fetchedArticles = await response.json();
      if (Array.isArray(fetchedArticles) && fetchedArticles.length > 0) {
        articles = fetchedArticles;
        console.log(`[HeroSlider] Fetched ${articles.length} featured articles for slider`);
      } else {
        // Try without categories relationship if first query returns empty
        console.log('[HeroSlider] No articles with categories, trying without relationship...');
        response = await fetch(
          `${SUPABASE_URL}/rest/v1/articles?select=id,title,slug,excerpt,featured_image,published_at,featured_video_url&status=eq.published&order=published_at.desc&limit=${limit}`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
            },
          }
        );
        
        if (response.ok) {
          const fallbackArticles = await response.json();
          if (Array.isArray(fallbackArticles) && fallbackArticles.length > 0) {
            articles = fallbackArticles;
            console.log(`[HeroSlider] Fallback: Fetched ${articles.length} articles`);
          }
        }
      }
    } else {
      const errorText = await response.text();
      console.error('[HeroSlider] Failed to fetch articles:', response.status, response.statusText);
      console.error('[HeroSlider] Error details:', errorText);
    }
  } catch (error) {
    console.error('[HeroSlider] Error fetching featured articles:', error);
  }
}

// Normalize article data with YouTube support
const normalizedArticles = articles.map(article => {
  const videoUrl = article.featured_video_url;
  const videoId = videoUrl ? getYouTubeVideoId(videoUrl) : null;
  const embedData = videoId ? getYouTubeEmbedUrl(videoUrl, {
    autoplay: 1,
    mute: 1,
    loop: 1,
    controls: 0,
    modestbranding: 1,
    rel: 0,
    playsinline: 1,
  }) : null;

  return {
    id: article.id,
    title: article.title,
    category: article.categories?.name || "Editorial",
    image: article.featured_image || "https://images.unsplash.com/photo-1523170335258-f5ed11844a49?w=1920&q=80",
    slug: article.slug,
    date: article.published_at 
      ? new Date(article.published_at).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        }) 
      : "",
    videoUrl: videoUrl,
    hasVideo: !!embedData,
    embedData: embedData,
  };
});

const hasArticles = normalizedArticles.length > 0;
---

{hasArticles ? (
  <div 
    class="hero-slider relative h-[70vh] md:h-[80vh] overflow-hidden"
    role="region"
    aria-roledescription="carousel"
    aria-label="Featured articles"
  >
    <!-- Slides -->
    {normalizedArticles.map((article, index) => (
      <div 
        class:list={["slide absolute inset-0", { "active": index === 0 }]}
        data-slide-index={index}
        role="group"
        aria-roledescription="slide"
        aria-label={`${index + 1} of ${normalizedArticles.length}: ${article.title}`}
        aria-hidden={index !== 0 ? "true" : "false"}
      >
        <!-- Background (Video or Image) -->
        {article.hasVideo && article.embedData ? (
          <!-- YouTube Video Background -->
          <div class="slide-video-bg absolute inset-0">
            <iframe
              src={article.embedData.embedUrl}
              title={article.title}
              class="video-iframe"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              loading={index === 0 ? "eager" : "lazy"}
            />
            <!-- Gradient Overlays -->
            <div class="overlay-horizontal absolute inset-0"></div>
            <div class="overlay-vertical absolute inset-0"></div>
          </div>
        ) : (
          <!-- Image Background -->
          <div class="slide-image-bg absolute inset-0">
            <img
              src={article.image}
              alt={article.title}
              class="w-full h-full object-cover"
              loading={index === 0 ? "eager" : "lazy"}
              decoding={index === 0 ? "sync" : "async"}
            />
            <!-- Gradient Overlays -->
            <div class="overlay-horizontal absolute inset-0"></div>
            <div class="overlay-vertical absolute inset-0"></div>
          </div>
        )}

        <!-- Content -->
        <div class="relative h-full container mx-auto px-4 sm:px-6 flex items-end pb-12 sm:pb-16">
          <div class="max-w-3xl slide-content">
            <!-- Category Badge -->
            <div class="mb-3 sm:mb-4">
              <span class="inline-block px-3 sm:px-4 py-1 bg-[hsl(var(--primary))] text-[hsl(var(--primary-foreground))] text-xs font-semibold uppercase tracking-wider">
                {article.category}
              </span>
            </div>

            <!-- Title -->
            <h2 class="font-serif text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-light mb-6 sm:mb-8 leading-loose text-white tracking-luxury">
              {article.title}
            </h2>

            <!-- Meta Info -->
            <div class="flex items-center gap-4 sm:gap-6 text-sm sm:text-base text-white/80 mb-8 sm:mb-10 font-light">
              <span>Lux Exposé</span>
              <span>•</span>
              <span>{article.date}</span>
            </div>

            <!-- CTA Button -->
            <a
              href={`/${article.slug}`}
              class="inline-flex items-center bg-[hsl(var(--primary))] hover:opacity-90 text-[hsl(var(--primary-foreground))] font-light uppercase tracking-luxury text-base px-8 py-4 rounded-lg transition-opacity"
            >
              Read Article
            </a>
          </div>
        </div>
      </div>
    ))}

    <!-- Navigation Arrows -->
    <button
      class="nav-arrow nav-arrow-left"
      aria-label="Previous slide"
      data-action="prev"
      type="button"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
    </button>

    <button
      class="nav-arrow nav-arrow-right"
      aria-label="Next slide"
      data-action="next"
      type="button"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m9 18 6-6-6-6"/>
      </svg>
    </button>

    <!-- Dot Indicators -->
    <div class="dots-container absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-2">
      {normalizedArticles.map((_, index) => (
        <button
          class:list={["dot w-2 h-2 rounded-full transition-all", { "active w-8 bg-[hsl(var(--primary))]": index === 0, "bg-[hsl(var(--muted-foreground)_/_0.5)]": index !== 0 }]}
          data-dot-index={index}
          aria-label={`Go to slide ${index + 1}`}
          aria-current={index === 0 ? "true" : "false"}
        />
      ))}
    </div>

    <!-- Progress Bar (Optional - luxury touch) -->
    <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-[hsl(var(--border)_/_0.2)]">
      <div class="progress-bar h-full bg-[hsl(var(--primary))] w-0 transition-all ease-linear" style="transition-duration: 10000ms;"></div>
    </div>
  </div>
) : (
  <!-- Placeholder when no articles -->
  <div class="relative h-[70vh] md:h-[80vh] overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-[hsl(var(--background))] via-[hsl(var(--background)_/_0.95)] to-[hsl(var(--primary)_/_0.1)]">
      <div class="absolute inset-0 opacity-30" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMyI+PHBhdGggZD0iTTM2IDM0djItaDJ2LTJoLTJ6bTAtNHYyaDJ2LTJoLTJ6bTAtNHYyaDJ2LTJoLTJ6bTAtNHYyaDJ2LTJoLTJ6bTAtNHYyaDJ2LTJoLTJ6bTAtNHYyaDJ2LTJoLTJ6bTAtNHYyaDJ2LTJoLTJ6bTAtNHYyaDJ2LTJoLTJ6bS00IDB2Mmg0di0yaC00em0tNCAwdjJoNHYtMmgtNHptLTQgMHYyaDR2LTJoLTR6bS00IDB2Mmg0di0yaC00em0tNCAwdjJoNHYtMmgtNHptLTQgMHYyaDR2LTJoLTR6bS00IDB2Mmg0di0yaC00em0tNCAwdjJoNHYtMmgtNHoiLz48L2c+PC9nPjwvc3ZnPg==');"></div>
    </div>
    <div class="relative h-full container mx-auto px-4 sm:px-6 flex items-center justify-center">
      <div class="text-center space-y-4">
        <h2 class="font-serif text-4xl md:text-6xl text-[hsl(var(--foreground))]">
          Lux Exposé
        </h2>
        <p class="text-xl md:text-2xl text-[hsl(var(--muted-foreground))]">
          Your Premier Luxury Lifestyle Magazine
        </p>
      </div>
    </div>
  </div>
)}

<style>
  /* Slide transitions */
  .slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    z-index: 0;
    pointer-events: none;
    transition: opacity 1s ease-in-out, z-index 0s linear 1s;
  }

  .slide.active {
    opacity: 1;
    z-index: 1;
    pointer-events: auto;
    transition: opacity 1s ease-in-out, z-index 0s linear 0s;
  }

  /* Content animation on active */
  .slide.active .slide-content {
    animation: fade-in 0.6s ease-out 0.3s forwards;
    opacity: 0;
  }

  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Video Background Container */
  .slide-video-bg {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  /* YouTube iFrame Sizing (maintains 16:9 aspect ratio, covers container) */
  .video-iframe {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    
    /* Cover calculation: ensures video covers viewport */
    width: 177.77vh; /* 16:9 ratio = 100vh * (16/9) = 177.77vh */
    height: 56.25vw; /* 16:9 ratio = 100vw * (9/16) = 56.25vw */
    min-width: 100%;
    min-height: 100%;
    
    border: none;
    pointer-events: none; /* Prevent interaction with video */
  }

  /* Gradient Overlays for Readability */
  .overlay-horizontal {
    background: linear-gradient(
      to right,
      hsl(var(--background) / 0.8) 0%,
      transparent 50%,
      transparent 100%
    );
    pointer-events: none;
  }

  .overlay-vertical {
    background: linear-gradient(
      to top,
      hsl(var(--background) / 0.6) 0%,
      transparent 40%,
      transparent 100%
    );
    pointer-events: none;
  }

  /* Image Background */
  .slide-image-bg {
    position: absolute;
    inset: 0;
  }

  /* Luxury letter spacing */
  .tracking-luxury {
    letter-spacing: 0.1em;
  }

  /* Dot active state */
  .dot.active {
    width: 2rem;
    background: hsl(var(--primary));
  }

  /* Progress bar animation */
  .progress-bar.animating {
    width: 100%;
  }

  /* Navigation Arrows - Critical CSS */
  .hero-slider {
    position: relative; /* REQUIRED for absolute positioning of arrows */
  }

  .nav-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 20; /* Must be higher than slides (z-index: 1) */
    
    /* Visibility */
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white; /* SVG stroke color */
    cursor: pointer;
    
    /* Transitions */
    transition: all 0.3s ease;
    
    /* Ensure visibility */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nav-arrow svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
  }

  @media (min-width: 640px) {
    .nav-arrow {
      padding: 0.875rem;
    }
    .nav-arrow svg {
      width: 32px;
      height: 32px;
    }
  }

  .nav-arrow:hover {
    background: rgba(0, 0, 0, 0.5);
    border-color: hsl(var(--luxury-gold) / 0.5);
    transform: translateY(-50%) scale(1.1);
  }

  .nav-arrow:active {
    transform: translateY(-50%) scale(0.95);
  }

  .nav-arrow-left {
    left: 1rem;
  }

  @media (min-width: 640px) {
    .nav-arrow-left {
      left: 1.5rem;
    }
  }

  .nav-arrow-right {
    right: 1rem;
  }

  @media (min-width: 640px) {
    .nav-arrow-right {
      right: 1.5rem;
    }
  }

  /* Hide arrows if only one slide */
  .hero-slider:has(.slide:only-child) .nav-arrow {
    display: none;
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .slide {
      transition: opacity 0.3s ease;
    }
    .slide.active .slide-content {
      animation: none;
      opacity: 1;
    }
    .progress-bar {
      display: none;
    }
    .nav-arrow {
      transition: background 0.2s ease;
    }
    .nav-arrow:hover {
      transform: translateY(-50%);
    }
  }
</style>

<script>
  // Hero Slider JavaScript
  class HeroSlider {
    constructor(container) {
      this.container = container;
      this.slides = container.querySelectorAll('[data-slide-index]');
      this.dots = container.querySelectorAll('[data-dot-index]');
      this.progressBar = container.querySelector('.progress-bar');
      this.currentIndex = 0;
      this.autoPlayInterval = null;
      this.AUTO_PLAY_DELAY = 10000; // 10 seconds
      this.isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      this.init();
    }

    init() {
      // Only initialize if we have more than one slide
      if (this.slides.length <= 1) return;

      // Arrow navigation
      const prevBtn = this.container.querySelector('[data-action="prev"]');
      const nextBtn = this.container.querySelector('[data-action="next"]');

      prevBtn?.addEventListener('click', () => {
        this.goToPrevious();
        this.resetAutoPlay();
      });
      nextBtn?.addEventListener('click', () => {
        this.goToNext();
        this.resetAutoPlay();
      });

      // Dot navigation
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          this.goToSlide(index);
          this.resetAutoPlay();
        });
      });

      // Keyboard navigation
      this.container.addEventListener('keydown', (e) => this.handleKeydown(e));

      // Touch/swipe support
      this.setupTouchEvents();

      // Pause on hover
      this.container.addEventListener('mouseenter', () => this.pauseAutoPlay());
      this.container.addEventListener('mouseleave', () => this.startAutoPlay());

      // Pause when tab is hidden
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          this.pauseAutoPlay();
        } else {
          this.startAutoPlay();
        }
      });

      // Start auto-play
      if (!this.isReducedMotion) {
        this.startAutoPlay();
      }
    }

    goToSlide(index) {
      if (index < 0 || index >= this.slides.length) return;
      if (index === this.currentIndex) return;

      // Remove active from current slide
      this.slides[this.currentIndex].classList.remove('active');
      this.slides[this.currentIndex].setAttribute('aria-hidden', 'true');
      
      // Update dots
      const currentDot = this.dots[this.currentIndex];
      if (currentDot) {
        currentDot.classList.remove('active', 'w-8', 'bg-[hsl(var(--primary))]');
        currentDot.classList.add('bg-[hsl(var(--muted-foreground)_/_0.5)]');
        currentDot.setAttribute('aria-current', 'false');
      }

      // Set new index
      this.currentIndex = index;

      // Add active to new slide
      this.slides[this.currentIndex].classList.add('active');
      this.slides[this.currentIndex].setAttribute('aria-hidden', 'false');
      
      // Update dots
      const newDot = this.dots[this.currentIndex];
      if (newDot) {
        newDot.classList.add('active', 'w-8', 'bg-[hsl(var(--primary))]');
        newDot.classList.remove('bg-[hsl(var(--muted-foreground)_/_0.5)]');
        newDot.setAttribute('aria-current', 'true');
      }

      // Reset progress bar
      this.resetProgressBar();
    }

    goToNext() {
      const nextIndex = (this.currentIndex + 1) % this.slides.length;
      this.goToSlide(nextIndex);
    }

    goToPrevious() {
      const prevIndex = (this.currentIndex - 1 + this.slides.length) % this.slides.length;
      this.goToSlide(prevIndex);
    }

    handleKeydown(e) {
      // Only handle if slider is focused or container is in viewport
      if (!this.container.contains(document.activeElement) && 
          !this.container.matches(':hover')) {
        return;
      }

      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        this.goToPrevious();
        this.resetAutoPlay();
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        this.goToNext();
        this.resetAutoPlay();
      }
    }

    setupTouchEvents() {
      let touchStartX = 0;
      let touchEndX = 0;

      this.container.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      this.container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        this.handleSwipe(touchStartX, touchEndX);
      }, { passive: true });
    }

    handleSwipe(startX, endX) {
      const swipeThreshold = 50;
      const diff = startX - endX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          // Swipe left - go next
          this.goToNext();
        } else {
          // Swipe right - go previous
          this.goToPrevious();
        }
        this.resetAutoPlay();
      }
    }

    startAutoPlay() {
      if (this.isReducedMotion || this.slides.length <= 1) return;
      
      this.pauseAutoPlay();
      
      // Start progress bar animation
      if (this.progressBar) {
        this.progressBar.classList.add('animating');
      }

      this.autoPlayInterval = setInterval(() => {
        this.goToNext();
      }, this.AUTO_PLAY_DELAY);
    }

    pauseAutoPlay() {
      if (this.autoPlayInterval) {
        clearInterval(this.autoPlayInterval);
        this.autoPlayInterval = null;
      }
      this.resetProgressBar();
    }

    resetAutoPlay() {
      this.pauseAutoPlay();
      if (!this.isReducedMotion && this.slides.length > 1) {
        this.startAutoPlay();
      }
    }

    resetProgressBar() {
      if (this.progressBar) {
        this.progressBar.classList.remove('animating');
        // Force reflow
        void this.progressBar.offsetWidth;
        this.progressBar.classList.add('animating');
      }
    }

    // Cleanup method
    public destroy() {
      this.pauseAutoPlay();
    }
  }

  // Initialize all sliders
  document.addEventListener('DOMContentLoaded', () => {
    const sliders = document.querySelectorAll('.hero-slider');
    sliders.forEach(slider => new HeroSlider(slider));
  });

  // Also handle Astro's view transitions
  document.addEventListener('astro:page-load', () => {
    const sliders = document.querySelectorAll('.hero-slider');
    sliders.forEach(slider => {
      if (!slider.dataset.initialized) {
        new HeroSlider(slider);
        slider.dataset.initialized = 'true';
      }
    });
  });
</script>

