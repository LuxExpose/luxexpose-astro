---
// src/components/city/CityMainNav.astro
import { cities, categoryOrder, featuredCategorySlugs } from '../../data/cities';

interface Props {
  city: 'boston' | 'miami' | 'nyc' | 'doha';
  categories: Array<{ name: string; slug: string; path: string }>;
  activeCategorySlug?: string;
}

const { city, categories, activeCategorySlug } = Astro.props;

// City display config
const cityConfig = {
  boston: { name: 'BOSTON', accent: 'boston-accent' },
  miami: { name: 'MIAMI', accent: 'miami-accent' },
  nyc: { name: 'NEW YORK', accent: 'nyc-accent' },
  doha: { name: 'DOHA', accent: 'doha-accent' },
};

const config = cityConfig[city];

// Filter other cities for network dropdown
const otherCities = cities.filter(c => c.slug !== city);

// Sort and split categories
const sortedCategories = [...categories].sort((a, b) => {
  const indexA = categoryOrder.indexOf(a.slug);
  const indexB = categoryOrder.indexOf(b.slug);
  if (indexA !== -1 && indexB !== -1) return indexA - indexB;
  if (indexA !== -1) return -1;
  if (indexB !== -1) return 1;
  return a.name.localeCompare(b.name);
});

// Filter featured categories - check if slug matches (case-insensitive and handle variations)
const featuredCategories = sortedCategories.filter(cat => {
  const catSlug = cat.slug.toLowerCase();
  return featuredCategorySlugs.some(featured => {
    const featuredSlug = featured.toLowerCase();
    // Exact match or handle common variations
    return catSlug === featuredSlug || 
           catSlug === featuredSlug.replace(/-/g, '') ||
           catSlug.includes(featuredSlug) ||
           featuredSlug.includes(catSlug);
  });
});

// All other categories go in dropdown
const dropdownCategories = sortedCategories.filter(cat => {
  const catSlug = cat.slug.toLowerCase();
  return !featuredCategorySlugs.some(featured => {
    const featuredSlug = featured.toLowerCase();
    return catSlug === featuredSlug || 
           catSlug === featuredSlug.replace(/-/g, '') ||
           catSlug.includes(featuredSlug) ||
           featuredSlug.includes(catSlug);
  });
});

// Get city accent color CSS variable
const cityAccentVar = `var(--${config.accent})`;
---

<div class="main-nav">
  <div class="nav-container">
    <div class="nav-content">
      
      <!-- Logo with Network Badge -->
      <a href={`/${city}`} class="logo-link">
        <img src="/images/lux-logo.png" alt="Lux Emblem" class="logo-emblem" />
        <div class="logo-text">
          <div class="logo-title">
            <span class="lux-text">LUX</span>
            <span class="boston-text" style={`color: hsl(${cityAccentVar})`}>{config.name}</span>
          </div>
          <div class="logo-tagline">Part of the Lux Exposé Network</div>
        </div>
      </a>
      
      <!-- Desktop Navigation -->
      <nav class="desktop-nav">
        
        <!-- Network Dropdown -->
        <div class="nav-dropdown" data-dropdown="network">
          <button class="nav-trigger" data-dropdown-trigger="network" aria-expanded="false">
            NETWORK
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </button>
          <div class="dropdown-panel glass-card-menu" data-dropdown-content="network">
            <div class="dropdown-inner">
              <div class="dropdown-header">
                <h3 class="dropdown-title">Lux Exposé Network</h3>
                <p class="dropdown-subtitle">Luxury experiences worldwide</p>
              </div>
              
              <!-- Global Link (highlighted with border) -->
              <a href="/" class="city-link city-link-global">
                <h3>Lux Exposé Global</h3>
                <p>Worldwide luxury content & experiences</p>
              </a>
              
              <!-- Other Cities -->
              {otherCities.map((otherCity) => (
                <a href={otherCity.path} class="city-link" key={otherCity.slug}>
                  <h3>{otherCity.name}</h3>
                  <p>{otherCity.description}</p>
                </a>
              ))}
            </div>
          </div>
        </div>
        
        <!-- Featured Categories (Direct Links) -->
        {featuredCategories.map((category) => {
          const isActive = activeCategorySlug === category.slug;
          return (
            <a 
              href={category.path}
              class:list={['nav-link', { 'nav-link--active': isActive }]}
              data-active={isActive}
              key={category.slug}
            >
              {category.name}
            </a>
          );
        })}
        
        <!-- More Categories Dropdown -->
        {dropdownCategories.length > 0 && (
          <div class="nav-dropdown" data-dropdown="more">
            <button class="nav-trigger" data-dropdown-trigger="more" aria-expanded="false">
              MORE
              <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div class="dropdown-panel glass-card-menu" data-dropdown-content="more">
              <div class="dropdown-grid">
                {dropdownCategories.map((category) => {
                  const isActive = activeCategorySlug === category.slug;
                  return (
                    <a 
                      href={category.path}
                      class:list={['category-link', { 'category-link--active': isActive }]}
                      key={category.slug}
                    >
                      {category.name}
                    </a>
                  );
                })}
              </div>
            </div>
          </div>
        )}
      </nav>
      
      <!-- Right Actions -->
      <div class="nav-actions">
        <!-- User Menu (desktop) -->
        <div class="user-menu">
          <button class="user-trigger" id="user-menu-trigger" aria-label="User menu" aria-expanded="false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <span class="user-email">graphicpayne@...</span>
          </button>
        </div>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-toggle" id="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false">
          <svg class="icon-menu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
          <svg class="icon-close hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobile-menu">
      <div class="mobile-menu-content">
        <!-- Featured Categories -->
        {featuredCategories.map((category) => (
          <a href={category.path} class="mobile-link mobile-link--featured" key={category.slug}>
            {category.name}
          </a>
        ))}
        
        <!-- More Categories -->
        {dropdownCategories.length > 0 && (
          <>
            <div class="mobile-divider">
              <span>More Categories</span>
            </div>
            {dropdownCategories.map((category) => (
              <a href={category.path} class="mobile-link" key={category.slug}>
                {category.name}
              </a>
            ))}
          </>
        )}
        
        <!-- Other Cities -->
        {otherCities.length > 0 && (
          <>
            <div class="mobile-divider">
              <span>Other Cities</span>
            </div>
            {otherCities.map((otherCity) => (
              <a href={otherCity.path} class="mobile-link" key={otherCity.slug}>
                {otherCity.name}
              </a>
            ))}
          </>
        )}
        
        <!-- Back to Main Site -->
        <a href="/" class="mobile-link mobile-link--back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Visit Lux Exposé
        </a>
      </div>
    </div>
  </div>
</div>

<style define:vars={{ cityAccent: cityAccentVar }}>
  /* Main Nav Container */
  .main-nav {
    width: 100%;
    max-width: 80rem;
    margin: 0 auto;
    padding: 0 0.75rem;
  }
  
  @media (min-width: 640px) {
    .main-nav {
      padding: 0 1rem;
    }
  }
  
  @media (min-width: 1024px) {
    .main-nav {
      padding: 0 1.5rem;
    }
  }
  
  .nav-container {
    width: 100%;
    max-width: 80rem; /* max-w-7xl = 1280px */
    margin: 0 auto;
    padding: 0.75rem 0.75rem; /* py-3 px-3 */
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  
  @media (min-width: 640px) {
    .nav-container {
      padding: 1rem 1rem; /* sm:py-4 sm:px-4 */
    }
  }
  
  @media (min-width: 1024px) {
    .nav-container {
      padding: 0.75rem 1.5rem; /* lg:py-3 lg:px-6 */
    }
  }
  
  .nav-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    gap: 1rem;
  }
  
  /* ========== LOGO ========== */
  .logo-link {
    display: flex;
    align-items: center;
    gap: 0.75rem; /* 12px - gap-3 */
    opacity: 1;
    transition: opacity 0.2s;
    flex-shrink: 0;
    text-decoration: none;
  }
  
  .logo-link:hover {
    opacity: 0.8;
  }
  
  .logo-emblem {
    height: 32px; /* Mobile */
    width: auto;
  }
  
  @media (min-width: 640px) {
    .logo-emblem {
      height: 40px;
    }
  }
  
  @media (min-width: 768px) {
    .logo-emblem {
      height: 48px;
    }
  }
  
  .logo-text {
    display: flex;
    flex-direction: column;
  }
  
  .logo-title {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* 8px - gap-2 */
    font-family: 'Cormorant Garamond', serif;
    font-weight: 700;
    letter-spacing: 0.05em; /* tracking-wider */
    white-space: nowrap;
    font-size: 1.125rem; /* 18px - text-lg */
  }
  
  @media (min-width: 640px) {
    .logo-title {
      font-size: 1.25rem; /* 20px - text-xl */
    }
  }
  
  @media (min-width: 768px) {
    .logo-title {
      font-size: 1.5rem; /* 24px - text-2xl */
    }
  }
  
  .lux-text {
    color: var(--foreground);
  }
  
  .boston-text {
    /* Color set via inline style with city accent */
  }
  
  .logo-tagline {
    display: none; /* Hidden on mobile */
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    color: var(--muted-foreground);
    letter-spacing: 0.025em;
    margin-top: -4px;
  }
  
  @media (min-width: 640px) {
    .logo-tagline {
      display: block;
    }
  }
  
  /* ========== DESKTOP NAVIGATION ========== */
  .desktop-nav {
    display: none;
    align-items: center;
    gap: 1rem; /* gap-4 */
  }
  
  @media (min-width: 1024px) {
    .desktop-nav {
      display: flex;
      gap: 1.5rem; /* gap-6 */
    }
  }
  
  @media (min-width: 1280px) {
    .desktop-nav {
      gap: 1.5rem; /* xl:gap-6 */
    }
  }
  
  /* Nav Links */
  .nav-link {
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem; /* 14px */
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em; /* tracking-wider */
    color: var(--muted-foreground);
    text-decoration: none;
    transition: color 0.3s;
    white-space: nowrap;
  }
  
  .nav-link:hover {
    color: var(--foreground);
  }
  
  .nav-link--active {
    color: var(--foreground);
    font-weight: 700;
    border-bottom: 2px solid hsl(var(--cityAccent));
    padding-bottom: 2px;
  }
  
  /* Nav Dropdown */
  .nav-dropdown {
    position: relative;
  }
  
  .nav-trigger {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem; /* 14px */
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em; /* tracking-wider */
    color: var(--muted-foreground);
    background: transparent;
    border: none;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .nav-trigger:hover,
  .nav-trigger[aria-expanded="true"] {
    color: var(--foreground);
    background: rgba(255, 255, 255, 0.05);
  }
  
  .chevron {
    width: 12px;
    height: 12px;
    transition: transform 0.3s ease;
  }
  
  .nav-trigger[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }
  
  /* Dropdown Panel */
  .dropdown-panel {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.5rem;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.5rem);
    transition: all 0.3s ease;
    z-index: 50;
  }
  
  .nav-dropdown.open .dropdown-panel {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  /* Glass Card Menu */
  .glass-card-menu {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 0.5px solid rgba(218, 165, 32, 0.3); /* Gold tint */
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    border-radius: 0.75rem; /* rounded-xl */
    z-index: 50;
  }
  
  .dropdown-inner {
    width: 25rem; /* 400px */
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .dropdown-header {
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 0.75rem;
  }
  
  .dropdown-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--primary);
    margin-bottom: 0.25rem;
    margin: 0 0 0.25rem 0;
  }
  
  .dropdown-subtitle {
    font-size: 0.75rem;
    color: var(--muted-foreground);
    margin: 0;
  }
  
  /* Network Links (City Links) */
  .city-link {
    display: block;
    padding: 0.75rem;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: background-color 0.3s;
  }
  
  .city-link:hover {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .city-link-global {
    border: 1px solid rgba(var(--primary), 0.2);
  }
  
  .city-link h3 {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 700;
    color: var(--foreground);
    transition: color 0.3s;
    margin: 0;
  }
  
  .city-link:hover h3 {
    color: var(--primary);
  }
  
  .city-link p {
    font-size: 0.75rem;
    color: var(--muted-foreground);
    margin-top: 0.25rem;
    margin-bottom: 0;
  }
  
  /* Categories Dropdown Grid */
  .dropdown-grid {
    width: 25rem;
    padding: 1.5rem;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }
  
  .category-link {
    padding: 0.75rem;
    border-radius: 0.5rem;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    color: hsl(var(--foreground));
    transition: all 0.3s ease;
  }
  
  .category-link:hover {
    background: hsl(var(--muted) / 0.5);
    color: hsl(var(--primary));
  }
  
  .category-link--active {
    background: hsl(var(--cityAccent) / 0.1);
    border-left: 2px solid hsl(var(--cityAccent));
    color: hsl(var(--cityAccent));
    font-weight: 600;
  }
  
  /* ========== NAV ACTIONS ========== */
  .nav-actions {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    flex-shrink: 0;
  }
  
  @media (min-width: 640px) {
    .nav-actions {
      gap: 0.5rem;
    }
  }
  
  @media (min-width: 768px) {
    .nav-actions {
      gap: 0.75rem;
    }
  }
  
  /* User Menu */
  .user-menu {
    display: none;
  }
  
  @media (min-width: 768px) {
    .user-menu {
      display: flex;
      align-items: center;
    }
  }
  
  .user-trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 0.875rem;
    color: hsl(0 0% 60%);
    background: transparent;
    border: none;
    padding: 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    max-width: 180px;
    transition: all 0.3s ease;
  }
  
  .user-trigger:hover {
    color: hsl(0 0% 98%);
    background: rgba(255, 255, 255, 0.05);
  }
  
  .user-trigger svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }
  
  .user-email {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Mobile Toggle */
  .mobile-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    color: hsl(0 0% 60%);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .mobile-toggle:hover {
    color: hsl(0 0% 98%);
    background: rgba(255, 255, 255, 0.05);
  }
  
  @media (min-width: 1024px) {
    .mobile-toggle {
      display: none;
    }
  }
  
  .mobile-toggle svg {
    width: 1.125rem;
    height: 1.125rem;
  }
  
  .hidden {
    display: none;
  }
  
  /* ========== MOBILE MENU ========== */
  .mobile-menu {
    display: none;
    padding: 1rem 0;
    border-top: 1px solid hsl(var(--border));
    animation: fade-in 0.3s ease;
  }
  
  .mobile-menu.open {
    display: block;
  }
  
  @media (min-width: 1024px) {
    .mobile-menu {
      display: none !important;
    }
  }
  
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-0.5rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .mobile-menu-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .mobile-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: hsl(var(--foreground));
    text-decoration: none;
    border-radius: 0.5rem;
    transition: background 0.3s ease;
  }
  
  .mobile-link:hover {
    background: hsl(var(--muted));
  }
  
  .mobile-link--featured {
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .mobile-link--back {
    color: hsl(var(--muted-foreground));
  }
  
  .mobile-link--back:hover {
    color: hsl(var(--foreground));
  }
  
  .mobile-divider {
    padding: 0.5rem 1rem;
    margin-top: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid hsl(var(--border));
  }
  
  .mobile-divider span {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: hsl(var(--muted-foreground));
    font-weight: 600;
  }
</style>

<script>
  // Dropdown toggle logic
  document.querySelectorAll('[data-dropdown-trigger]').forEach(trigger => {
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdownId = trigger.getAttribute('data-dropdown-trigger');
      const dropdown = trigger.closest('.nav-dropdown');
      const isOpen = dropdown?.classList.contains('open');
      
      // Close all dropdowns first
      document.querySelectorAll('.nav-dropdown').forEach(d => {
        d.classList.remove('open');
        d.querySelector('[data-dropdown-trigger]')?.setAttribute('aria-expanded', 'false');
      });
      
      // Toggle current dropdown
      if (!isOpen) {
        dropdown?.classList.add('open');
        trigger.setAttribute('aria-expanded', 'true');
      }
    });
  });
  
  // Close dropdowns on outside click
  document.addEventListener('click', (e) => {
    if (!(e.target as Element).closest('.nav-dropdown')) {
      document.querySelectorAll('.nav-dropdown').forEach(d => {
        d.classList.remove('open');
        d.querySelector('[data-dropdown-trigger]')?.setAttribute('aria-expanded', 'false');
      });
    }
  });
  
  // Mobile menu toggle
  const mobileToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const iconMenu = mobileToggle?.querySelector('.icon-menu');
  const iconClose = mobileToggle?.querySelector('.icon-close');
  
  mobileToggle?.addEventListener('click', () => {
    const isOpen = mobileMenu?.classList.contains('open');
    mobileMenu?.classList.toggle('open', !isOpen);
    mobileToggle.setAttribute('aria-expanded', String(!isOpen));
    iconMenu?.classList.toggle('hidden', !isOpen);
    iconClose?.classList.toggle('hidden', isOpen);
  });
  
  // Close mobile menu on link click
  mobileMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      mobileMenu.classList.remove('open');
      mobileToggle?.setAttribute('aria-expanded', 'false');
      iconMenu?.classList.remove('hidden');
      iconClose?.classList.add('hidden');
    });
  });
</script>

